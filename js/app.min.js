new Vue({el:"#app",data:()=>({isAutoScroll:!0,isShowTimestamp:!0,rxData:"",txData:"",rxObjData:{},rawOutputData:"",newLineOptions:[{label:"No line ending",value:"NO_LINE_ENDING"},{label:"Newline",value:"NEW_LINE"},{label:"Carriage return",value:"CARRIAGE_RETURN"},{label:"Both NL & CR",value:"BOTH_NL_AND_CR"}],newLineSelected:"NO_LINE_ENDING",baudrateOptions:[300,1200,2400,4800,9600,19200,38400,57600,115200],baudrate:115200,port:null,reader:null,onReadingSerial:!1,outputPanel:null,allRecordData:[],currentRecordData:{data:[{id:1,label:"Tk",value:"30.22"},{id:2,label:"To",value:"31.22"},{id:3,label:"Tgn",value:"33.22"},{id:4,label:"Tbl1",value:"34.22"},{id:5,label:"Tbl2",value:"35.22"}],timestamp:Date.now()},chart:null,chartLabels:[],chartData:[{label:"T1",data:[],borderWidth:1,borderColor:"#e74c3c"},{label:"T2",data:[],borderWidth:1,borderColor:"#3498db"},{label:"T3",data:[],borderWidth:1,borderColor:"#16a085"},{label:"T4",data:[],borderWidth:1,borderColor:"#34495e"},{label:"T5",data:[],borderWidth:1,borderColor:"#7f8c8d"}],excelData:""}),methods:{async handleConnect(){this.isConnected?await this.disconnectSerial():await this.connectSerial()},clearOutput(){this.rawOutputData="",this.excelData=""},async connectSerial(){try{setTimeout((()=>{this.onReadingSerial=!0,this.rxObjData={},this.rxData=""}),2e3);const t={usbVendorId:9025};this.port=await navigator.serial.requestPort({filters:[t]}),await this.port.open({baudRate:this.baudrate}),this.reader=this.port.readable.getReader();try{for(;;){const{value:t,done:a}=await this.reader.read();if(a)break;dnc=new TextDecoder("utf-8"),str=dnc.decode(t),this.onReadingSerial&&(this.rxData+=str,str.includes("\n")&&(this.rxObjData={timestamp:Date.now(),value:this.rxData},this.onReadline(),this.rxData=""))}}catch(t){}finally{this.reader.releaseLock()}}catch(t){this.rxData+=t+"\r\n"}},async disconnectSerial(){this.onReadingSerial=!1,this.reader.releaseLock(),await this.port.close(),this.port=null},onReadline(){this.isShowTimestamp?this.rawOutputData+=`${new Date(this.rxObjData.timestamp).toLocaleTimeString("vi-VN")} => ${this.rxObjData.value}`:this.rawOutputData+=this.rxData,this.isAutoScroll&&this.scrollToBottom(),this.mapRecordData(),this.mapChartData(),this.mapExcelData()},scrollToBottom(){this.outputPanel.scrollTop=this.outputPanel.scrollHeight},mapRecordData(){const t=this.rxData.trimEnd().split(",");this.currentRecordData.data[0].value=t[0]?t[0]:"-",this.currentRecordData.data[1].value=t[1]?t[1]:"-",this.currentRecordData.data[2].value=t[2]?t[2]:"-",this.currentRecordData.data[3].value=t[3]?t[3]:"-",this.currentRecordData.data[4].value=t[4]?t[4]:"-",this.currentRecordData.timestamp=(new Date).toString(),this.allRecordData.push(this.currentRecordData)},mapChartData(){const t=this.rxData.trimEnd().split(","),a=(new Date).toLocaleTimeString("vi-VN");this.addData(a,t)},addData(t,a){this.chart.data.labels.push(t),this.chart.data.datasets.forEach(((t,e)=>{t.data.push(a[e]||null)})),this.chart.update()},mapExcelData(){const t=this.rxData.trimEnd()+","+(new Date).toLocaleTimeString("vi-VN")+","+(new Date).toLocaleDateString("vi-VN")+"\r\n";this.excelData+=t},handleExportData(){const t="terminal-"+Date.now().toLocaleString("vi-VN")+".csv";this.download(this.excelData,t,"csv")},download(t,a,e){var r=new Blob([t],{type:e});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,a);else{var i=document.createElement("a"),o=URL.createObjectURL(r);i.href=o,i.download=a,document.body.appendChild(i),i.click(),setTimeout((function(){document.body.removeChild(i),window.URL.revokeObjectURL(o)}),0)}}},computed:{portInfo(){return this.port?.getInfo()||null},isConnected(){return!!this.portInfo?.usbVendorId},portReadable(){return this.port?.readable||null},outputData(){return this.rawOutputData}},mounted(){this.outputPanel=document.getElementById("output-panel"),this.scrollToBottom();const t=document.getElementById("myChart");this.chart=new Chart(t,{type:"line",data:{labels:this.chartLabels,datasets:this.chartData},options:{scales:{y:{beginAtZero:!0}}}})},destroy(){}});
