new Vue({el:"#app",data(){return{isAutoScroll:!0,isShowTimestamp:!0,rxData:"",txData:"",rxObjData:{},rawOutputData:"",newLineOptions:[{label:"No line ending",value:"NO_LINE_ENDING"},{label:"Newline",value:"NEW_LINE"},{label:"Carriage return",value:"CARRIAGE_RETURN"},{label:"Both NL & CR",value:"BOTH_NL_AND_CR"}],newLineSelected:"NO_LINE_ENDING",baudrateOptions:[300,1200,2400,4800,9600,19200,38400,57600,115200],baudrate:115200,port:null,reader:null,onReadingSerial:!1,outputPanel:null,allRecordData:[],currentRecordData:{data:[{id:1,label:"Tk",value:"30.22"},{id:2,label:"To",value:"31.22"},{id:3,label:"Tgn",value:"33.22"},{id:4,label:"Tbl1",value:"34.22"},{id:5,label:"Tbl2",value:"35.22"}],timestamp:Date.now()},chart:null,chartLabels:[],chartData:[{label:"T1",data:[],borderWidth:1,borderColor:"#e74c3c"},{label:"T2",data:[],borderWidth:1,borderColor:"#3498db"},{label:"T3",data:[],borderWidth:1,borderColor:"#16a085"},{label:"T4",data:[],borderWidth:1,borderColor:"#34495e"},{label:"T5",data:[],borderWidth:1,borderColor:"#7f8c8d"}]}},methods:{async handleConnect(){this.isConnected?await this.disconnectSerial():await this.connectSerial()},clearOutput(){this.rawOutputData=""},async connectSerial(){try{console.log("connect"),setTimeout(()=>{this.onReadingSerial=!0,console.log("START_READING_SERIAL"),this.rxObjData={},this.rxData=""},2e3);this.port=await navigator.serial.requestPort({filters:[{usbVendorId:9025}]}),await this.port.open({baudRate:this.baudrate}),this.reader=this.port.readable.getReader();try{for(;;){const{value:a,done:b}=await this.reader.read();if(b){console.log("reader break");break}dnc=new TextDecoder("utf-8"),str=dnc.decode(a),this.onReadingSerial&&(this.rxData+=str,str.includes("\n")&&(this.rxObjData={timestamp:Date.now(),value:this.rxData},this.onReadline(),this.rxData=""))}}catch(a){}finally{console.log("reader releaseLock"),this.reader.releaseLock()}}catch(a){console.log(a),this.rxData+=a+"\r\n"}},async disconnectSerial(){this.onReadingSerial=!1,this.reader.releaseLock(),await this.port.close(),this.port=null},onReadline(){this.rawOutputData+=this.isShowTimestamp?`${new Date(this.rxObjData.timestamp).toLocaleTimeString("vi-VN")} => ${this.rxObjData.value}`:this.rxData,this.isAutoScroll&&this.scrollToBottom(),this.mapRecordData(),this.mapChartData()},scrollToBottom(){this.outputPanel.scrollTop=this.outputPanel.scrollHeight},mapRecordData(){const a=this.rxData.trimEnd().split(",");this.currentRecordData.data[0].value=a[0]?a[0]:"-",this.currentRecordData.data[1].value=a[1]?a[1]:"-",this.currentRecordData.data[2].value=a[2]?a[2]:"-",this.currentRecordData.data[3].value=a[3]?a[3]:"-",this.currentRecordData.data[4].value=a[4]?a[4]:"-",this.currentRecordData.timestamp=new Date().toString(),this.allRecordData.push(this.currentRecordData)},mapChartData(){const a=this.rxData.trimEnd().split(","),b=new Date().toLocaleTimeString("vi-VN");this.addData(b,a)},addData(a,b){this.chart.data.labels.push(a),this.chart.data.datasets.forEach((a,c)=>{a.data.push(b[c]||null)}),this.chart.update()}},computed:{portInfo(){return this.port?.getInfo()||null},isConnected(){return!!this.portInfo?.usbVendorId},portReadable(){return this.port?.readable||null},outputData(){return this.rawOutputData}},mounted(){this.outputPanel=document.getElementById("output-panel"),this.scrollToBottom();const a=document.getElementById("myChart");this.chart=new Chart(a,{type:"line",data:{labels:this.chartLabels,datasets:this.chartData},options:{scales:{y:{beginAtZero:!0}}}}),console.log(this.chart)},destroy(){}});
